<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="theme-color" content="#ee6e73" />
	<title>Accounts Web Application</title>
	<link rel="icon" href="/images/favicon.ico" type="image/x-icon" />
	<link rel="manifest" href="/manifest.json">
	<link rel="stylesheet" href="css/materialize.min.css">
	<link href="css/icon.css" rel="stylesheet">
    <script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
    <script src="js/materialize.min.js"></script>  
    <script src="js/app.js"></script>  
    <script src="js/date.min.js"></script>
    <style type="text/css">
    	.status_icon {
		    width: 20px;
		    height: 17px;
		    margin-right: 10px;
		    margin-bottom: -3px;
    	}
    
    </style>
</head>
<body>
	<input type="hidden" id="network-status" value="ONLINE" />
	<nav class="nav-extended">
		<div class="nav-wrapper">
			<a href="#" class="brand-logo">Accounts</a>
			<a href="#" data-activates="mobile-demo" class="button-collapse"><i class="material-icons">menu</i></a>
		</div>
		<div class="nav-content">
			<ul class="tabs tabs-transparent">
				<li class="tab"><a class="active" href="#test1">Test 1</a></li>
				<li class="tab"><a href="#test2">Test 2</a></li>
			</ul>
		</div>
	</nav>
	<div id="test1" class="col s12">
		<div class="progress" style="margin-top: 0px;">
		    <div class="indeterminate"></div>
		</div>
		<div style="width: 300px; margin-top: 20px;">
			<div class="col s12">
				<div class="row">
					<div class="input-field col s12">
						<i class="material-icons prefix">description</i>
						<input type="text" id="autocomplete-input" class="autocomplete">
						<label id=""for="autocomplete-input">Autocomplete</label>
						<ul class="autocomplete-content dropdown-content" id="ac-list"></ul>
					</div>
				</div>
			</div>
		</div>
        <p style="margin-left: 15px;">
        	<i class="material-icons prefix" style="margin-top: 10px; font-size: 30px;">swap_vert</i>
			<input class="with-gap" name="tx-type" type="radio" id="tx-type-debit" value="DEBIT" checked />
			<label for="tx-type-debit" style="margin-left: 10px;">Debit</label>
			<input class="with-gap" name="tx-type" type="radio" id="tx-type-credit" value="CREDIT" />
			<label for="tx-type-credit" style="margin-left: 40px;">Credit</label>
		</p>
		<div class="input-field col s6" style="width: 300px; margin-top: 25px; margin-left: 12px;">
			<i class="material-icons prefix" style="margin-top: 15px;">attach_money</i>
			<input id="icon_prefix" type="text" class="validate">
			<label for="icon_prefix">Amount</label>
        </div>
        <button id="save-btn" class="btn waves-effect waves-light" type="submit" name="action" style="margin-left: 55px; margin-top: 40px;">Submit
			<i class="material-icons right">send</i>
		</button>
	</div>
	<div id="test2" class="col s12">
		<div class="progress prog-listing" style="margin-top: 0px;">
		    <div class="indeterminate"></div>
		</div>
		<table>
			<thead>
				<tr>
					<th>Description</th>
					<th>Type</th>
					<th>Amount</th>
					<th>Date</th>
				</tr>
			</thead>
			<tbody id="listing-content">
			</tbody>
	    </table>
	</div>
	<script type="text/javascript">
		var baseUrl = 'https://wfly10-accounts-wa-accounts.1d35.starter-us-east-1.openshiftapps.com';
// 		var baseUrl = 'http://localhost:80';
		window.addEventListener('load', function() {
		  function updateOnlineStatus(event) {
		    if (navigator.onLine) {
		    	$('#network-status').val("ONLINE");
		    	Materialize.toast("App is now online", 4000);
		    	syncLocalData();
		    	populateEntriesListingPage();
		    } else {
		    	$('#network-status').val("OFFLINE");
		    	populateEntriesListingPage();
		    	Materialize.toast("App just went offline", 4000);
		    }
		  }
		
		  window.addEventListener('online', updateOnlineStatus);
		  window.addEventListener('offline', updateOnlineStatus);
		});
		$(document).ready(function(){
			$('div.progress').hide();
			$('div.prog-listing').hide();
			$("a", ".tab").click(function() {
				$('div.prog-listing').show();
				if(this.href.indexOf("#test2") !== -1) {
					if(isOnline()) {
						var request = $.ajax({
	        				url: baseUrl + "/rest/entries",
	        				type: "GET",
	        	            crossDomain: true,
	        			});
			    		request.done(function(response) {
			    			putDataToLocalStorage(response);
			    			populateEntriesListingPage();
			    		});
			    		request.fail(function(jqXHR, textStatus) {
			    			Materialize.toast(textStatus, 4000);
			        	});	
					} else {
						populateEntriesListingPage();
					}
				}
		    });
			$("input.autocomplete").keyup(function(){
		    	var text = $(this).val();
		        if(text.length >= 4) {
		        	$('div.progress').show();
		        	var request = $.ajax({
		        				url: baseUrl + "/rest/autocomplete/descriptions?text=" + text,
		        				type: "GET",
		        	            crossDomain: true,
		        			});
	        		request.done(function(response) {
	        			var htmlContent = '';
	        			$.each(response, function(key,value) {
	        				htmlContent += '<li onclick="populateAutocomplete(\'' + value.transactionName + '\')"><span>' + value.transactionName + '</span></li>';
	        			});
	        			htmlContent += '</ul>';
	        			$('#ac-list').html(htmlContent);
	        			$('div.progress').hide();
	        		});
	        		request.fail(function(jqXHR, textStatus) {
        		    	alert( "Request failed: " + textStatus );
        		    	$('div.progress').hide();
		        	});
		        } else {
		        	$('#ac-list').html('');
		        }
		    });
			$('#save-btn').click(function() {
				$('div.progress').show();
		    	var requestObject = new Object();
		    	requestObject.transactionName = $('#autocomplete-input').val();
		    	requestObject.transactionType = $("input[name='tx-type']:checked").val();
		    	requestObject.amount = $('#icon_prefix').val();
		    	requestObject.updatedDate = convertDateToUTC(new Date()).toString("yyyy-MM-dd HH:mm:ss");
		    	requestObject.id = null;
		    	if(isOnline()) {
			    	$.ajax({
						url: baseUrl + "/rest/entry",
						type: "PUT",
						data: JSON.stringify(requestObject),
						dataType: "json",
						contentType: "application/json",
			            crossDomain: true,
						statusCode: {
					        200: function (response) {
					        	$('div.progress').hide();
					        	Materialize.toast('Data Saved', 4000);
					        },
					        400: function (response) {
								$('div.progress').hide();
					        	Materialize.toast(response.responseJSON.message, 4000);
					        },
					        404: function (response) {
			    				$('div.progress').hide();
					        	Materialize.toast('Service unavailable. Try after some time.', 4000);
					      	},
					      	503: function(response) {
								$('div.progress').hide();
					        	Materialize.toast("Internal wiring just crashed. Let us fix it :)", 4000);
					      	}
						},
						success: function () {
							$('div.progress').hide();
				        	Materialize.toast('Data Saved', 4000);
					    }
	    			});
		    	} else{
		    		var storedData = getDataFromLocalStorage();
		    		storedData.push(requestObject);
		    		putDataToLocalStorage(storedData);
		    		Materialize.toast("Data saved locally. Will sync once app is connected to internet", 4000);
		    	}
		    });
		});
		function populateAutocomplete(text) {
	    	$('#autocomplete-input').val(text);
	    	$('#ac-list').html('');
		}
		function populateEntriesListingPage() {
			$('#listing-content').html('');
			var htmlContent = '';
			var storedData = getDataFromLocalStorage();
			$.each(storedData, function(key,value) {
				var img_status = '', img_title = '';
				if(isOnline() && (value.id != null || value.id != undefined)) {
					img_status = 'images/item-online.png';
					img_title = 'Data served online';
				} else if(isOnline() === "ONLINE" && (value.id == null || value.id === undefined)) {
					img_status = 'images/item-not-synced.png';
					img_title = 'Data served from local storage(Not Synced)';
				} else {
					img_status = 'images/item-offline.png';
					img_title = 'Data served from local storage(Synced)';
				}
				htmlContent += '<tr><td><img src="' + img_status + '" class="status_icon" title="' + img_title + '"/>' + value.transactionName + '</td><td>' + value.transactionType + '</td><td>' + value.amount + '</td><td>' + convertDateToLocal(value.updatedDate).toString("yyyy-MM-dd HH:mm:ss") + '</td></tr>';
			});
			$('#listing-content').html(htmlContent);
			$('div.prog-listing').hide();
		}
		function getDataFromLocalStorage() {
			var storedData = [];
			if(localStorage.accountEntries != undefined 
					&& localStorage.accountEntries != 'undefined' 
					&& localStorage.accountEntries != null 
					&& localStorage.accountEntries != 'null' 
					&& localStorage.accountEntries.length > 0) {
				storedData = JSON.parse(localStorage.accountEntries);
			}
			storedData.sort(function(a,b){
				return new Date(b.updatedDate) - new Date(a.updatedDate);
			});
			return storedData;
		}
		function putDataToLocalStorage(data) {
			var storedData = getDataFromLocalStorage();
			if(data != undefined && data != 'undefined' && data != null && data != 'null' && data.length > 0) {
				storedData.push.apply(storedData, data);
				localStorage.accountEntries = JSON.stringify(storedData);
			}
		}
		function isOnline() {
			var status = false;
			if($('#network-status').val() === "ONLINE") {
				status = true;
			}
			return status;
		}
		function syncLocalData() {
			var storedData = getDataFromLocalStorage();
			var updateCount = 0;
			$.each(storedData, function(key,value) {
				if(value.id == undefined || value.id == null) {
					$.ajax({
						url: baseUrl + "/rest/entry",
						type: "PUT",
						data: JSON.stringify(value),
						dataType: "json",
						contentType: "application/json",
			            crossDomain: true,
						statusCode: {
					        200: function (response) {
					        	updateCount++;
					        	Materialize.toast('Synced Rs.' + value.amount + ' ' + value.transactionType + ' transaction with name ' + value.transactionName + '.', 4000);
					        	var refreshedLSData = getDataFromLocalStorage();
					        	for(var i = 0; i < refreshedLSData.length; i++) {
					        		if(refreshedLSData[i].transactionName === value.transactionName 
					        				&& refreshedLSData[i].transactionType === value.transactionType
					        				&& refreshedLSData[i].amount === value.amount
					        				&& refreshedLSData[i].updatedDate === value.updatedDate) {
					        			refreshedLSData.splice(i, 1);
					        		}
					        	}
					        	localStorage.accountEntries = JSON.stringify(refreshedLSData);
					        },
					        400: function (response) {
					        },
					        404: function (response) {
					      	},
					      	503: function(response) {
					      	}
						},
						success: function () {
				        	updateCount++;
				        	Materialize.toast('Synced Rs.' + value.amount + ' ' + value.transactionType + ' transaction with name ' + value.transactionName + '.', 4000);
				        	var refreshedLSData = getDataFromLocalStorage();
				        	for(var i = 0; i < refreshedLSData.length; i++) {
				        		if(refreshedLSData[i].transactionName === value.transactionName 
				        				&& refreshedLSData[i].transactionType === value.transactionType
				        				&& refreshedLSData[i].amount === value.amount
				        				&& refreshedLSData[i].updatedDate === value.updatedDate) {
				        			refreshedLSData.splice(i, 1);
				        		}
				        	}
				        	localStorage.accountEntries = JSON.stringify(refreshedLSData);
					    }
	    			});
				}
			});
		}
		function convertDateToUTC(date) {
			return new Date(date.getUTCFullYear(), 
					date.getUTCMonth(), 
					date.getUTCDate(), 
					date.getUTCHours(), 
					date.getUTCMinutes(), 
					date.getUTCSeconds());
		}
		function convertDateToLocal(date) {
			return new Date(date + ' UTC').toString();
		}
	</script>
	<img src="images/item-not-synced.png" style="display: none;" />
	<img src="images/item-offline.png" style="display: none;" />
	<img src="images/item-online.png" style="display: none;" />
</body>
</html>